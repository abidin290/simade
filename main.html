<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Data Penduduk - AdminLTE</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <style>.table-hover tbody tr:hover { cursor: pointer; background-color: rgba(0,0,0,.075); }</style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav"><li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li></ul>
  </nav>

  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="main.html" class="brand-link">
      <i class="fa fa-database brand-image img-circle elevation-3" style="opacity: .8"></i>
      <span class="brand-text font-weight-light">Data Penduduk</span>
    </a>
    <div class="sidebar">
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image"><i class="fa fa-user-circle fa-2x text-white"></i></div>
        <div class="info"><a href="#" class="d-block" id="usernameLabel">Pengguna</a></div>
      </div>
      <nav class="mt-2" id="sidebar-nav"></nav>
    </div>
  </aside>

  <div class="content-wrapper">
    <div class="content-header">
      <div class="container-fluid"><div class="row mb-2"><div class="col-sm-6"><h1 class="m-0">Dashboard Data Penduduk</h1></div></div></div>
    </div>
    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-header"><h3 class="card-title">Filter Data</h3></div>
          <div class="card-body"><input id="searchInput" type="text" class="form-control" placeholder="Cari berdasarkan nama, NIK, pekerjaan, dusun..."></div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Daftar Penduduk</h3></div>
            <div class="card-body table-responsive p-0">
                <div id="statusContainer" class="p-3"></div>
                <table class="table table-hover text-nowrap">
                    <thead>
                        <tr>
                            <th>Nama Lengkap</th>
                            <th class="text-center">Umur</th>
                            <th>Pekerjaan</th>
                            <th>Pendidikan Terakhir</th>
                            <th style="width: 100px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="pendudukList"></tbody>
                </table>
            </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="main-footer"><strong>Copyright &copy; 2024-2025.</strong> All rights reserved.</footer>
</div>

<div class="modal fade" id="biodataModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Detail Biodata Penduduk</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
    <div class="modal-body"><div id="biodataSection"></div></div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button></div>
</div></div></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<script>
    const SCRIPT_URL = "URL_GAS_UTAMA_ANDA"; // PASTIKAN URL INI BENAR
    const authToken = sessionStorage.getItem("authToken");
    let allPenduduk = [], debounceTimer;

    if (!authToken) { window.location.href = "index.html"; }

    // Skrip untuk Sidebar Dinamis
    document.addEventListener("DOMContentLoaded", function() {
        const username = sessionStorage.getItem("username") || "Pengguna";
        const userRole = sessionStorage.getItem("userRole") || "user";
        document.getElementById("usernameLabel").textContent = username;
        const currentPage = window.location.pathname.split('/').pop();
        let navHTML = '<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false"><li class="nav-header">NAVIGASI UTAMA</li>';
        const menuItems = [
            { href: "main.html", icon: "fa-tachometer-alt", text: "Dashboard Penduduk" },
            { href: "keluarga.html", icon: "fa-users", text: "Manajemen KK" },
            { href: "statistik.html", icon: "fa-chart-pie", text: "Statistik" },
            { href: "galeri.html", icon: "fa-image", text: "Galeri" }
        ];
        menuItems.forEach(item => {
            const activeClass = (currentPage === item.href) ? 'active' : '';
            navHTML += `<li class="nav-item"><a href="${item.href}" class="nav-link ${activeClass}"><i class="nav-icon fas ${item.icon}"></i><p>${item.text}</p></a></li>`;
        });
        if (userRole === 'admin') {
            const activeClass = (currentPage === 'admin_panel.html') ? 'active' : '';
            navHTML += '<li class="nav-header">PENGATURAN</li>';
            navHTML += `<li class="nav-item"><a href="admin_panel.html" class="nav-link ${activeClass}"><i class="nav-icon fas fa-cogs"></i><p>Admin Panel</p></a></li>`;
        }
        navHTML += `<li class="nav-item" style="margin-top: 20px;"><a href="#" onclick="logout()" class="nav-link bg-danger"><i class="nav-icon fas fa-sign-out-alt"></i><p>Logout</p></a></li></ul>`;
        document.getElementById("sidebar-nav").innerHTML = navHTML;
    });

    function logout(){
      sessionStorage.removeItem("authToken");
      sessionStorage.removeItem("username");
      sessionStorage.removeItem("userRole");
      window.location.href="index.html";
    }

    async function apiCall(action, params={}) {
      try {
        const res = await fetch(SCRIPT_URL, {
          method:"POST", headers:{"Content-Type":"text/plain"},
          body:JSON.stringify({ action, token:authToken, ...params })
        });
        return await res.json();
      } catch(e) { return { success:false, message:e.message }; }
    }

    function showStatus(msg, type) {
      const div = document.getElementById("statusContainer");
      if (msg) {
        let alertClass = 'alert-info';
        if (type === 'error') alertClass = 'alert-danger';
        div.innerHTML = `<div class="alert ${alertClass} m-3">${msg}</div>`;
      } else {
        div.innerHTML = '';
      }
    }

    async function loadPenduduk(){
      showStatus("Memuat data penduduk...", "info");
      const data = await apiCall("listPenduduk");
      if(data.success && Array.isArray(data.penduduk)){ 
          allPenduduk = data.penduduk; 
          displayPenduduk(allPenduduk); 
          showStatus("");
      } else {
          showStatus(data.message || "Gagal memuat data atau format salah.", "error");
      }
      document.getElementById("searchInput").addEventListener("input", () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterPenduduk, 300);
      });
    }

    function displayPenduduk(arr){
      const tbody = document.getElementById("pendudukList");
      tbody.innerHTML = "";
      if (arr.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5' class='text-center text-muted p-4'>Data tidak ditemukan.</td></tr>";
          return;
      }
      arr.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${p.nama}</strong></td>
            <td class="text-center">${p.umur || 'N/A'}</td>
            <td>${p.pekerjaan || 'N/A'}</td>
            <td>${p.pendidikan || 'N/A'}</td>
            <td><button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); showBiodata('${p.nik}')"><i class="fas fa-eye"></i> Detail</button></td>
        `;
        row.addEventListener('click', () => showBiodata(p.nik));
        tbody.appendChild(row);
      });
    }

    function filterPenduduk(){
      const q = document.getElementById("searchInput").value.toLowerCase().trim();
      const res = allPenduduk.filter(p=> Object.values(p).some(v=> String(v).toLowerCase().includes(q)));
      displayPenduduk(res); 
    }

    function formatTanggal(tgl){
      if(!tgl) return "N/A";
      try {
          const d = new Date(tgl);
          if (isNaN(d.getTime())) return "Tanggal tidak valid";
          return d.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
      } catch(e) { return "N/A"; }
    }

    function showBiodata(nik){
      const p = allPenduduk.find(e=>e.nik===nik);
      if(!p) return;
      const tgl = formatTanggal(p.tanggalLahir);
      document.getElementById("biodataSection").innerHTML = `<table class="table table-bordered table-striped"><tbody>
            <tr><th style="width: 200px;">Nama Lengkap</th><td>${p.nama || 'N/A'}</td></tr>
            <tr><th>NIK</th><td>${p.nik || 'N/A'}</td></tr>
            <tr><th>No. KK</th><td>${p.noKK || 'N/A'}</td></tr>
            <tr><th>Tempat, Tgl Lahir</th><td>${p.tempatLahir || 'N/A'}, ${tgl}</td></tr>
            <tr><th>Umur</th><td>${p.umur ? p.umur + ' Tahun' : 'N/A'}</td></tr>
            <tr><th>Jenis Kelamin</th><td>${p.jenisKelamin || 'N/A'}</td></tr>
            <tr><th>Agama</th><td>${p.agama || 'N/A'}</td></tr>
            <tr><th>Pendidikan Terakhir</th><td>${p.pendidikan || 'N/A'}</td></tr>
            <tr><th>Pekerjaan</th><td>${p.pekerjaan || 'N/A'}</td></tr>
            <tr><th>Status Hubungan</th><td>${p.statusHubungan || 'N/A'}</td></tr>
            <tr><th>Dusun</th><td>${p.dusun || 'N/A'}</td></tr>
            </tbody></table>`;
      $('#biodataModal').modal('show');
    }

    $(document).ready(function() {
        loadPenduduk();
    });
</script>
</body>
</html>

