<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Manajemen Desa</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
</head>
<body class="hold-transition sidebar-mini">

<script>
    // Skrip Keamanan: Memeriksa peran pengguna sebelum memuat halaman.
    if (sessionStorage.getItem("userRole") !== 'admin') {
        alert("Akses ditolak! Halaman ini hanya untuk Admin.");
        window.location.href = 'main.html';
    }
</script>

<div class="wrapper">
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav"><li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li></ul>
  </nav>

  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="main.html" class="brand-link"><i class="fa fa-database brand-image img-circle elevation-3" style="opacity: .8"></i><span class="brand-text font-weight-light">Data Penduduk</span></a>
    <div class="sidebar">
      <div class="user-panel mt-3 pb-3 mb-3 d-flex"><div class="image"><i class="fa fa-user-circle fa-2x text-white"></i></div><div class="info"><a href="#" class="d-block" id="usernameLabel">Pengguna</a></div></div>
      <nav class="mt-2" id="sidebar-nav"></nav>
    </div>
  </aside>

  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid"><div class="row mb-2"><div class="col-sm-6"><h1 class="m-0">Admin Panel</h1></div></div></div>
    </section>
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-7">
            <div class="card card-primary card-outline">
              <div class="card-header"><h3 class="card-title">Pengaturan Album Galeri</h3></div>
              <div class="card-body">
                <p class="text-muted">Pilih satu atau beberapa folder untuk ditampilkan di galeri dengan mencentang kotak "Aktif".</p>
                <div id="folder-inputs-container">
                  <!-- Input akan dibuat oleh JavaScript -->
                </div>
                <button type="button" id="saveFolderBtn" class="btn btn-primary mt-3">Simpan Pengaturan Galeri</button>
                <div id="folderStatus" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="card card-info">
              <div class="card-header"><h3 class="card-title">Manajemen Pengguna</h3></div>
              <div class="card-body">
                <button class="btn btn-success mb-3" data-toggle="modal" data-target="#userModal" id="addUserBtn"><i class="fas fa-plus"></i> Tambah Pengguna</button>
                <div id="userStatus" class="mt-2"></div>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead><tr><th>Username</th><th>Role</th><th>Aksi</th></tr></thead>
                        <tbody id="userList"></tbody>
                    </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="main-footer"><strong>Copyright &copy; 2024-2025.</strong> All rights reserved.</footer>
</div>

<!-- Modal Manajemen Pengguna -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="userModalLabel">Tambah Pengguna Baru</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
      <div class="modal-body">
        <form id="userForm">
          <input type="hidden" id="originalUsername">
          <div class="form-group"><label for="usernameInput">Username</label><input type="text" class="form-control" id="usernameInput" required></div>
          <div class="form-group"><label for="passwordInput">Password</label><input type="password" class="form-control" id="passwordInput"><small id="passwordHelp" class="form-text text-muted">Kosongkan jika tidak ingin mengubah password.</small></div>
          <div class="form-group"><label for="roleSelect">Role</label><select class="form-control" id="roleSelect" required><option value="user">User</option><option value="admin">Admin</option></select></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="saveUserBtn">Simpan</button></div>
    </div>
  </div>
</div>

<!-- Modal Konfirmasi Hapus -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger"><h5 class="modal-title">Konfirmasi Hapus</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
            <div class="modal-body"><p>Apakah Anda yakin ingin menghapus pengguna <strong id="userToDelete"></strong>?</p></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Ya, Hapus</button></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVJsNbfIliujHhgYUPGWFwyGse-Z5m4l7A-CNr2qwXOnj2xZBQKASeTQLRgW5zLvpW/exec"; // PASTIKAN URL INI BENAR
    const authToken = sessionStorage.getItem("authToken");

    // --- SKRIP SIDEBAR DINAMIS & LOGOUT ---
    document.addEventListener("DOMContentLoaded", function() {
        const username = sessionStorage.getItem("username") || "Pengguna";
        const userRole = sessionStorage.getItem("userRole") || "user";
        document.getElementById("usernameLabel").textContent = username;
        const currentPage = window.location.pathname.split('/').pop();
        let navHTML = '<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false"><li class="nav-header">NAVIGASI UTAMA</li>';
        const menuItems = [
            { href: "main.html", icon: "fa-tachometer-alt", text: "Dashboard Penduduk" },
            { href: "keluarga.html", icon: "fa-users", text: "Manajemen KK" },
            { href: "statistik.html", icon: "fa-chart-pie", text: "Statistik" },
            { href: "galeri.html", icon: "fa-image", text: "Galeri" }
        ];
        menuItems.forEach(item => {
            const activeClass = (currentPage === item.href) ? 'active' : '';
            navHTML += `<li class="nav-item"><a href="${item.href}" class="nav-link ${activeClass}"><i class="nav-icon fas ${item.icon}"></i><p>${item.text}</p></a></li>`;
        });
        if (userRole === 'admin') {
            const activeClass = (currentPage === 'admin_panel.html') ? 'active' : '';
            navHTML += '<li class="nav-header">PENGATURAN</li>';
            navHTML += `<li class="nav-item"><a href="admin_panel.html" class="nav-link ${activeClass}"><i class="nav-icon fas fa-cogs"></i><p>Admin Panel</p></a></li>`;
        }
        navHTML += `<li class="nav-item" style="margin-top: 20px;"><a href="#" onclick="logout()" class="nav-link bg-danger"><i class="nav-icon fas fa-sign-out-alt"></i><p>Logout</p></a></li>`;
        navHTML += '</ul>';
        document.getElementById("sidebar-nav").innerHTML = navHTML;
    });

    function logout(){
      sessionStorage.removeItem("authToken");
      sessionStorage.removeItem("username");
      sessionStorage.removeItem("userRole");
      window.location.href="index.html";
    }

    // --- FUNGSI UTAMA UNTUK KOMUNIKASI DENGAN GAS ---
    async function apiCall(action, params = {}) {
        try {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ action, token: authToken, ...params })
            });
            return await res.json();
        } catch (e) {
            console.error("API Call Error:", e);
            return { success: false, message: "Gagal terhubung ke server." };
        }
    }

    // --- BAGIAN PENGATURAN GALERI ---
    const folderInputsContainer = document.getElementById('folder-inputs-container');
    const saveFolderBtn = document.getElementById('saveFolderBtn');
    const folderStatus = document.getElementById('folderStatus');
    const MAX_FOLDERS = 5;

    function showFolderStatus(message, type) {
        let alertClass = type === 'success' ? 'alert-success' : (type === 'error' ? 'alert-danger' : 'alert-info');
        folderStatus.innerHTML = `<div class="alert ${alertClass} py-2">${message}</div>`;
    }

    function renderFolderInputs(settings) {
        // PERBAIKAN: Memastikan 'settings' dan 'settings.folders' / 'settings.activeIds' adalah array yang valid
        const folders = (settings && Array.isArray(settings.folders)) ? settings.folders : [];
        const activeIds = (settings && Array.isArray(settings.activeIds)) ? settings.activeIds : [];

        let html = '';
        for (let i = 0; i < MAX_FOLDERS; i++) {
            const item = folders[i] || { name: '', id: '' };
            const isChecked = item.id && activeIds.includes(item.id) ? 'checked' : '';
            const isDisabled = !item.id ? 'disabled' : '';
            html += `
                <div class="input-group mb-2">
                    <div class="input-group-prepend"><div class="input-group-text">
                        <input type="checkbox" class="active-folder-checkbox" value="${item.id}" ${isChecked} ${isDisabled}>
                    </div></div>
                    <input type="text" class="form-control col-4 album-name" placeholder="Nama Album ${i + 1}" value="${item.name}">
                    <input type="text" class="form-control col-7 album-id" placeholder="ID Folder ${i + 1}" value="${item.id}">
                </div>`;
        }
        folderInputsContainer.innerHTML = html;
    }

    async function loadCurrentFolderData() {
        showFolderStatus("Memuat pengaturan folder...", "info");
        const response = await apiCall("getFolderId");
        if (response.success && response.settings) { // Ditambah pengecekan response.settings
            renderFolderInputs(response.settings);
            showFolderStatus("Pengaturan berhasil dimuat.", "success");
        } else {
            showFolderStatus("Gagal memuat: " + (response.message || "Data tidak ditemukan."), "error");
            renderFolderInputs(); // Tampilkan input kosong jika gagal
        }
    }

    async function saveFolderData() {
        const folderData = [];
        const nameInputs = document.querySelectorAll('.album-name');
        const idInputs = document.querySelectorAll('.album-id');
        const activeIds = Array.from(document.querySelectorAll('.active-folder-checkbox:checked')).map(cb => cb.value);

        for (let i = 0; i < MAX_FOLDERS; i++) {
            const name = nameInputs[i].value.trim();
            const id = idInputs[i].value.trim();
            folderData.push({ name: name, id: id });
        }

        saveFolderBtn.disabled = true;
        saveFolderBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        
        const response = await apiCall("setFolderId", { folderData, activeIds });
        showFolderStatus(response.message, response.success ? "success" : "error");

        saveFolderBtn.disabled = false;
        saveFolderBtn.innerHTML = 'Simpan Pengaturan Galeri';
    }
    
    folderInputsContainer.addEventListener('input', (e) => {
        if (e.target.classList.contains('album-id')) {
            const checkbox = e.target.closest('.input-group').querySelector('input[type="checkbox"]');
            if (e.target.value.trim()) {
                checkbox.disabled = false;
                checkbox.value = e.target.value.trim();
            } else {
                checkbox.disabled = true;
                checkbox.checked = false;
                checkbox.value = "";
            }
        }
    });

    // --- BAGIAN MANAJEMEN PENGGUNA ---
    const userStatus = document.getElementById('userStatus');
    const userList = document.getElementById('userList');
    const userModal = $('#userModal');
    let isEditMode = false;

    function showUserStatus(message, type) {
        let alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        userStatus.innerHTML = `<div class="alert ${alertClass} py-2">${message}</div>`;
        setTimeout(() => { userStatus.innerHTML = ''; }, 3000);
    }

    async function loadUsers() {
        userList.innerHTML = '<tr><td colspan="3" class="text-center">Memuat...</td></tr>';
        const data = await apiCall("listUsers");
        if (data.success) {
            userList.innerHTML = "";
            data.users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'badge-success' : 'badge-secondary'}">${user.role}</span></td>
                    <td>
                        <button class="btn btn-xs btn-warning" onclick="editUser('${user.username}', '${user.role}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-xs btn-danger" onclick="deleteUser('${user.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                userList.appendChild(row);
            });
        } else {
            userList.innerHTML = `<tr><td colspan="3" class="text-center text-danger">${data.message}</td></tr>`;
        }
    }
    
    document.getElementById('addUserBtn').addEventListener('click', () => {
        isEditMode = false;
        document.getElementById('userForm').reset();
        document.getElementById('userModalLabel').textContent = 'Tambah Pengguna Baru';
        document.getElementById('usernameInput').readOnly = false;
        document.getElementById('passwordInput').required = true;
        document.getElementById('passwordHelp').style.display = 'none';
    });

    function editUser(username, role) {
        isEditMode = true;
        document.getElementById('userForm').reset();
        document.getElementById('userModalLabel').textContent = 'Edit Pengguna';
        document.getElementById('originalUsername').value = username;
        document.getElementById('usernameInput').value = username;
        document.getElementById('usernameInput').readOnly = true;
        document.getElementById('roleSelect').value = role;
        document.getElementById('passwordInput').required = false;
        document.getElementById('passwordHelp').style.display = 'block';
        userModal.modal('show');
    }

    async function handleSaveUser() {
        const username = document.getElementById('usernameInput').value;
        const password = document.getElementById('passwordInput').value;
        const role = document.getElementById('roleSelect').value;

        let response;
        if (isEditMode) {
            const originalUsername = document.getElementById('originalUsername').value;
            response = await apiCall("updateUser", { username: originalUsername, newPassword: password, newRole: role });
        } else {
            response = await apiCall("addUser", { newUsername: username, newPassword: password, newRole: role });
        }

        showUserStatus(response.message, response.success ? 'success' : 'error');
        if (response.success) {
            userModal.modal('hide');
            loadUsers();
        }
    }

    function deleteUser(username) {
        document.getElementById('userToDelete').textContent = username;
        $('#deleteConfirmModal').modal('show');
        
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener('click', async () => {
            const response = await apiCall("deleteUser", { username: username });
            showUser-Status(response.message, response.success ? 'success' : 'error');
            $('#deleteConfirmModal').modal('hide');
            if (response.success) {
                loadUsers();
            }
        });
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        loadCurrentFolderData();
        saveFolderBtn.addEventListener('click', saveFolderData);
        loadUsers();
        document.getElementById('saveUserBtn').addEventListener('click', handleSaveUser);
    });
</script>
</body>
</html>
