<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manajemen Kartu Keluarga - AdminLTE</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <style>
    .table-hover tbody tr:hover { cursor: pointer; }
  </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav"><li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li></ul>
  </nav>

  <!-- SIDEBAR DINAMIS BARU -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="main.html" class="brand-link">
      <i class="fa fa-database brand-image img-circle elevation-3" style="opacity: .8"></i>
      <span class="brand-text font-weight-light">Data Penduduk</span>
    </a>
    <div class="sidebar">
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image"><i class="fa fa-user-circle fa-2x text-white"></i></div>
        <div class="info"><a href="#" class="d-block" id="usernameLabel">Pengguna</a></div>
      </div>
      <nav class="mt-2" id="sidebar-nav"></nav>
    </div>
  </aside>

  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid"><div class="row mb-2"><div class="col-sm-6"><h1 class="m-0">Manajemen Kartu Keluarga (KK)</h1></div></div></div>
    </section>
    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Daftar Keluarga</h3>
            <div class="card-tools">
              <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="searchInput" class="form-control float-right" placeholder="Cari No. KK atau Nama Kepala Keluarga">
              </div>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            <div id="statusContainer" class="p-3"></div>
            <table class="table table-hover text-nowrap">
              <thead><tr><th>No. Kartu Keluarga</th><th>Kepala Keluarga</th><th class="text-center">Jumlah Anggota</th><th class="text-center">Aksi</th></tr></thead>
              <tbody id="keluargaList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="main-footer"><strong>Copyright &copy; 2024-2025.</strong> All rights reserved.</footer>
</div>

<div class="modal fade" id="detailKeluargaModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Detail Anggota Keluarga</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
    <div class="modal-body">
        <h6 class="mb-3"><strong>No. KK:</strong> <span id="modalKkNumber"></span></h6>
        <div class="table-responsive"><table class="table table-bordered">
            <thead><tr><th>NIK</th><th>Nama Lengkap</th><th>Hubungan Keluarga</th><th>Jenis Kelamin</th><th>Usia</th></tr></thead>
            <tbody id="detailAnggotaKeluarga"></tbody>
        </table></div>
    </div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button></div>
</div></div></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVJsNbfIliujHhgYUPGWFwyGse-Z5m4l7A-CNr2qwXOnj2xZBQKASeTQLRgW5zLvpW/exec"; // PASTIKAN URL INI BENAR
    const authToken = sessionStorage.getItem("authToken");
    let allKeluargaData = {}, debounceTimer;

    if (!authToken) { window.location.href = "index.html"; }

    // --- SKRIP SIDEBAR DINAMIS ---
    document.addEventListener("DOMContentLoaded", function() {
        const username = sessionStorage.getItem("username") || "Pengguna";
        const userRole = sessionStorage.getItem("userRole") || "user";
        document.getElementById("usernameLabel").textContent = username;
        const currentPage = window.location.pathname.split('/').pop();
        let navHTML = '<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false"><li class="nav-header">NAVIGASI UTAMA</li>';
        const menuItems = [
            { href: "main.html", icon: "fa-tachometer-alt", text: "Dashboard Penduduk" },
            { href: "keluarga.html", icon: "fa-users", text: "Manajemen KK" },
            { href: "statistik.html", icon: "fa-chart-pie", text: "Statistik" },
            { href: "galeri.html", icon: "fa-image", text: "Galeri" }
        ];
        menuItems.forEach(item => {
            const activeClass = (currentPage === item.href) ? 'active' : '';
            navHTML += `<li class="nav-item"><a href="${item.href}" class="nav-link ${activeClass}"><i class="nav-icon fas ${item.icon}"></i><p>${item.text}</p></a></li>`;
        });
        if (userRole === 'admin') {
            const activeClass = (currentPage === 'admin_panel.html') ? 'active' : '';
            navHTML += '<li class="nav-header">PENGATURAN</li>';
            navHTML += `<li class="nav-item"><a href="admin_panel.html" class="nav-link ${activeClass}"><i class="nav-icon fas fa-cogs"></i><p>Admin Panel</p></a></li>`;
        }
        navHTML += `<li class="nav-item" style="margin-top: 20px;"><a href="#" onclick="logout()" class="nav-link bg-danger"><i class="nav-icon fas fa-sign-out-alt"></i><p>Logout</p></a></li></ul>`;
        document.getElementById("sidebar-nav").innerHTML = navHTML;
    });

    function logout(){
      sessionStorage.removeItem("authToken");
      sessionStorage.removeItem("username");
      sessionStorage.removeItem("userRole");
      window.location.href="index.html";
    }

    // --- Skrip untuk halaman ini ---
    async function fetchPenduduk() { /* ... (fungsi tetap sama) ... */ }
    function showStatus(msg, type) { /* ... (fungsi tetap sama) ... */ }
    function getAge(dobStr) { /* ... (fungsi tetap sama) ... */ }
    async function loadKeluarga() { /* ... (fungsi tetap sama) ... */ }
    function displayKeluargaList(data) { /* ... (fungsi tetap sama) ... */ }
    function showDetailKeluarga(noKK) { /* ... (fungsi tetap sama) ... */ }
    function filterKeluarga() { /* ... (fungsi tetap sama) ... */ }

    // Implementasi fungsi
    async function fetchPenduduk() {
      const res = await fetch(SCRIPT_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: "listPenduduk", token: authToken }) });
      const data = await res.json();
      return data.success ? data.penduduk : [];
    }
    function showStatus(msg, type) {
        const div = document.getElementById("statusContainer");
        if (msg) { let alertClass = type === 'error' ? 'alert-danger' : 'alert-info'; div.innerHTML = `<div class="alert ${alertClass}">${msg}</div>`; } 
        else { div.innerHTML = ''; }
    }
    function getAge(dobStr) {
        if (!dobStr) return 'N/A';
        return Math.floor((Date.now() - new Date(dobStr).getTime()) / 31557600000);
    }
    async function loadKeluarga() {
        showStatus("Memuat data keluarga...", "info");
        const penduduk = await fetchPenduduk();
        if (!penduduk || penduduk.length === 0) { showStatus("Data penduduk tidak ditemukan.", "error"); return; }
        const groupedByKk = penduduk.reduce((acc, p) => {
            const kk = p.noKK || 'Tanpa No. KK';
            if (!acc[kk]) { acc[kk] = { members: [], kepalaKeluarga: 'N/A' }; }
            acc[kk].members.push(p);
            if (String(p.statusHubungan || '').toLowerCase() === 'kk') { acc[kk].kepalaKeluarga = p.nama; }
            return acc;
        }, {});
        for (const kk in groupedByKk) {
            if (groupedByKk[kk].kepalaKeluarga === 'N/A' && groupedByKk[kk].members.length > 0) {
                groupedByKk[kk].kepalaKeluarga = groupedByKk[kk].members[0].nama;
            }
        }
        allKeluargaData = groupedByKk;
        displayKeluargaList(allKeluargaData);
        showStatus("");
    }
    function displayKeluargaList(data) {
        const tbody = document.getElementById("keluargaList");
        tbody.innerHTML = "";
        if (Object.keys(data).length === 0) { tbody.innerHTML = "<tr><td colspan='4' class='text-center p-4'>Data tidak ditemukan.</td></tr>"; return; }
        for (const noKK in data) {
            const keluarga = data[noKK];
            const row = document.createElement('tr');
            row.innerHTML = `<td>${noKK}</td><td><strong>${keluarga.kepalaKeluarga}</strong></td><td class="text-center"><span class="badge badge-info">${keluarga.members.length} Orang</span></td><td class="text-center"><button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); showDetailKeluarga('${noKK}')"><i class="fas fa-eye"></i> Detail</button></td>`;
            row.addEventListener('click', () => showDetailKeluarga(noKK));
            tbody.appendChild(row);
        }
    }
    function showDetailKeluarga(noKK) {
        const keluarga = allKeluargaData[noKK];
        if (!keluarga) return;
        const detailBody = document.getElementById("detailAnggotaKeluarga");
        document.getElementById("modalKkNumber").textContent = noKK;
        detailBody.innerHTML = "";
        keluarga.members.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${p.nik || 'N/A'}</td><td>${p.nama || 'N/A'}</td><td>${p.statusHubungan || 'N/A'}</td><td>${p.jenisKelamin || 'N/A'}</td><td>${getAge(p.tanggalLahir)}</td>`;
            detailBody.appendChild(row);
        });
        $('#detailKeluargaModal').modal('show');
    }
    function filterKeluarga() {
        const query = document.getElementById("searchInput").value.toLowerCase().trim();
        const filteredData = Object.keys(allKeluargaData).filter(noKK => noKK.toLowerCase().includes(query) || allKeluargaData[noKK].kepalaKeluarga.toLowerCase().includes(query)).reduce((obj, key) => { obj[key] = allKeluargaData[key]; return obj; }, {});
        displayKeluargaList(filteredData);
    }

    $(document).ready(function() {
        loadKeluarga();
        $('#searchInput').on('keyup', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(filterKeluarga, 300);
        });
    });
</script>
</body>
</html>
